library(dplyr)
library(survival)

## Table 1. Baseline characteristics of study cohort.

# Filter of database for . Patients not meeting the baseline criteria for early-stage systemic sclerosis are removed
df_filtered_baseline <- Database %>%
  filter(VISIT == "Baseline visit", CEOCCUR == 0)

## Total number of included patients
n_total <- nrow(df_filtered_baseline)
n_total

# Gender: counting male gender
n_male <- sum(df_filtered_baseline$SEX == 0, na.rm = TRUE)
n_tot_sex <- sum(!is.na(df_filtered_baseline$SEX))
pct_male <- round(100 * n_male / n_tot_sex, 1)
cat("Male:", n_male, "(", pct_male, "%)\n")

# Age: mean age with standard deviation
mean_age <- round(mean(df_filtered_baseline$AGE, na.rm = TRUE), 1)
sd_age <- round(sd(df_filtered_baseline$AGE, na.rm = TRUE), 1)
cat("Age:", mean_age, "(", sd_age, ")\n")

# ESR: the median ESR with interquartile range
esr_median <- median(df_filtered_baseline$LBTEST_ESR, na.rm = TRUE)
esr_q1 <- quantile(df_filtered_baseline$LBTEST_ESR, 0.25, na.rm = TRUE)
esr_q3 <- quantile(df_filtered_baseline$LBTEST_ESR, 0.75, na.rm = TRUE)
cat("ESR:", esr_median, "(", esr_q1, "-", esr_q3, ")\n")

# Capillary density: the median capillary density with interquartile range
cap_median <- median(df_filtered_baseline$LBTEST_CAPDEN, na.rm = TRUE)
cap_q1 <- quantile(df_filtered_baseline$LBTEST_CAPDEN, 0.25, na.rm = TRUE)
cap_q3 <- quantile(df_filtered_baseline$LBTEST_CAPDEN, 0.75, na.rm = TRUE)
cat("Capillary density:", cap_median, "(", cap_q1, "-", cap_q3, ")\n")

# Raynaud's Phenomenon: the median RP duration with interquartile range
rp_median <- median(df_filtered_baseline$RPDUR, na.rm = TRUE)
rp_q1 <- quantile(df_filtered_baseline$RPDUR, 0.25, na.rm = TRUE)
rp_q3 <- quantile(df_filtered_baseline$RPDUR, 0.75, na.rm = TRUE)
cat("RP duration (months):", rp_median, "(", rp_q1, "-", rp_q3, ")\n")

# Puffy fingers: the median PF duration with interquartile range
pf_median <- median(df_filtered_baseline$PUFFYDUR, na.rm = TRUE)
pf_q1 <- quantile(df_filtered_baseline$PUFFYDUR, 0.25, na.rm = TRUE)
pf_q3 <- quantile(df_filtered_baseline$PUFFYDUR, 0.75, na.rm = TRUE)
cat("Puffy finger duration (months):", pf_median, "(", pf_q1, "-", pf_q3, ")\n")

# ANA and ENA positivity
# Loop for counting and printing the number and valid percentage of positive cases for each variable
tests <- c(
  "SMOKE"                  = "Ever smoked",
  "CLVAL"                  = "Telangiectasia"
  "SMOKING"                = "Current smoking",
  "RPYN"                   = "Raynaud's phenomenon",
  "PUFFYFING"              = "Puffy fingers",
  "LBTEST_ANA"             = "ANA positive",
  "LBTEST_ENA"             = "ENA positive",
  "LBTEST_ACA"             = "ACA positive",
  "LBTEST_ATA"             = "ATA positive",
  "LBTEST_ARA"             = "ARA positive",
  "LBTEST_AntiFibrillarin" = "Anti-Fibrillarin positive",
  "LBTEST_AntiNOR90"       = "Anti-NOR90 positive",
  "LBTEST_AntiPMScl"       = "Anti-PMScl positive",
  "LBTEST_AntiKu"          = "Anti-Ku positive",
  "LBTEST_AntiPDGFR"       = "Anti-PDGFR positive",
  "LBTEST_AntiSSARo"       = "Anti-SSA/Ro positive",
  "LBTEST_Antihiston"      = "Anti-histon positive",
  "LBTEST_AntiJo1"         = "Anti-Jo1 positive",
  "LBTEST_AntiSM"          = "Anti-SM positive",
  "LBTEST_AntiRNP"         = "Anti-RNP positive",
  "LBTEST_AntiribosomaalP" = "Anti-ribosomaal P positive"
)

for (col in names(tests)) {
  n_pos <- sum(df_filtered_baseline[[col]] == 1, na.rm = TRUE)
  n_tot <- sum(!is.na(df_filtered_baseline[[col]]))
  perc  <- round(100 * n_pos / n_tot, 1)
  cat(tests[col], ":", n_pos, "(", perc, "%)\n")
}

## Figure 2. Cumulative incidence function for progression, including 95% CI with A time-to-event summary table was added to display the number of patients at risk, lost to follow-up, and progression events at each time point (year)

# Filtering dataset for progression analysis
df_filtered_event <- subset(Database, VISIT == "Follow-up" &  CNSR %in% c(0, 1))

surv_object <- Surv(pmin(df_filtered_event$ASTDT_years), df_filtered_event$CNSR)
fit <- survfit(surv_object ~ 1)
summary_fit <- summary(fit, times = c(0, 1, 2, 3, 4, 5))

time_points <- summary_fit$time
n_risk <- summary_fit$n.risk
n_event <- summary_fit$n.event
n_censor <- summary_fit$n.censor
cumulative_lost <- cumsum(n_censor)
cumulative_events <- cumsum(n_event)
surv_prob <- summary_fit$surv
cumulative_incidence <- 1 - surv_prob

dev.new(width = 7, height = 6)
par(mar = c(8, 5, 2, 5))
plot(fit,
     fun = function(x) {1 - x},
     xlab = "Time (years)",
     ylab = "Cumulative Incidence",
     main = "Cumulative Incidence Function for Progression",
     xlim = c(0, 5),
     ylim = c(0, 1),
     col = c("black"),
     lwd = c(2),
     lty = 1,
     mark.time = TRUE)
legend("topright",
       legend = c("Cumulative Incidence", "95% CI"),
       col = c("black", "black"),
       lty = c(1, 2),
       lwd = c(2, 1))
mtext("At risk", side = 1, line = 5, at = -1, adj = 0, cex = 1)
mtext("Lost", side = 1, line = 6, at = -1, adj = 0, cex = 1)
mtext("Events", side = 1, line = 7, at = -1, adj = 0, cex = 1)

for (i in 1:length(time_points)) {
  mtext(n_risk[i], side = 1, line = 5, at = time_points[i], adj = 0.5, cex = 1)
  mtext(cumulative_lost[i], side = 1, line = 6, at = time_points[i], adj = 0.5, cex = 1)
  mtext(cumulative_events[i], side = 1, line = 7, at = time_points[i], adj = 0.5, cex = 1)
}

# Median time to progression with IQR
p25_index <- which.min(abs(surv_prob - 0.75))
p75_index <- which.min(abs(surv_prob - 0.25))
p25_survival <- time_points[p25_index]
p75_survival <- time_points[p75_index]
median_survival <- median(time_points)

print(paste("Median survival time:", median_survival))
print(paste("25th percentile survival time:", p25_survival))
print(paste("75th percentile survival time:", p75_survival))

## Figure 3: Cumulative incidence function by ENA status
fit <- survfit(surv_object ~ ENA_GRP, data = df_filtered_event)
plot(fit,
     fun = function(x) {1 - x},
     xlab = "Time (years)",
     ylab = "Cumulative Incidence",
     main = "Cumulative Incidence by ENA Status",
     xlim = c(0, 5),
     ylim = c(0, 1),
     col = c("#900022", "#121591", "#888888", "black"),
     lwd = 2,
     mark.time = TRUE)

legend("bottomright",
       legend = c("ENA_ACA", "ENA_ATA", "ENA_other", "ENA_negative"),
       col = c("#900022", "#121591", "#888888", "black"),
       lty = 1,
       lwd = 2)


## Figure 4: Cumulative incidence function by telangiectasia status
fit <- survfit(surv_object ~ strata(CLVAL), data = df_filtered_event)
plot(fit,
     fun = function(x) {1 - x},
     xlab = "Time (years)",
     ylab = "Cumulative Incidence",
     main = "Cumulative Incidence by Telangiectasia Status",
     xlim = c(0, 5),
     ylim = c(0, 1),
     col = c("#888888", "black"),
     lwd = 2,
     mark.time = TRUE)
legend("topright",
       legend = c("Telangiectasia positive", "Telangiectasia negative"),
       col = c("black", "#888888"),
       lty = 1,
       lwd = 2)

## Figure 5: Cumulative incidence function by NCM mean capillary density divided into ≤ 7 and > 7
fit <- survfit(surv_object ~ factor(LBTEST4, levels = c("1", "2")), data = df_filtered_event)
plot(fit,
     fun = function(x) {1 - x},
     xlab = "Time (years)",
     ylab = "Cumulative Incidence",
     main = "Cumulative Incidence by Mean Capillary Density",
     xlim = c(0, 5),
     ylim = c(0, 1),
     col = c("black", "#888888"),
     lwd = 2,
     mark.time = TRUE)
legend("bottomright",
       legend = c("Mean density ≤ 7", "Mean density > 7"),
       col = c("black", "#888888"),
       lty = 1,
       lwd = 2)

## Figure 6: Cumulative incidence function by gender
fit <- survfit(surv_object ~ SEX, data = df_filtered_event)
plot(fit,
     fun = function(x) {1 - x},
     xlab = "Time (years)",
     ylab = "Cumulative Incidence",
     main = "Cumulative Incidence by Sex",
     xlim = c(0, 5),
     ylim = c(0, 1),
     col = c("black", "#888888"),
     lwd = 2,
     mark.time = TRUE)
legend("topright",
       legend = c("Male", "Female"),
       col = c("black", "#888888"),
       lty = 1,
       lwd = 2)

## Figure 7: Cumulative incidence function by age group, stratified into 20-45 years, 45-60 years, and 60+ years
fit <- survfit(surv_object ~ AGE, data = df_filtered_event)
plot(fit,
     fun = function(x) {1 - x},
     xlab = "Time (years)",
     ylab = "Cumulative Incidence",
     main = "Cumulative Incidence by Age Group",
     xlim = c(0, 5),
     ylim = c(0, 1),
     col = c("black", "#888888", "#121591"),
     lwd = 2,
     mark.time = TRUE)
legend("topright",
       legend = c("Age 20-45", "Age 45-60", "Age 60+"),
       col = c("black", "#888888", "#121591"),
       lty = 1,
       lwd = 2)


# Cox model for ENA group
surv_obj <- Surv(df_filtered_event$TIBDY, df_filtered_event$CEOCCUR)
cox_ENA <- coxph(surv_obj ~ ENAGRP, data = df_filtered_event)
summary(cox_ENA)


# Age group (3 classes)
cox_AGE <- coxph(surv_obj ~ AGEGR3, data = df_filtered_event)
summary_AGE <- summary(cox_AGE)
print(summary_AGE)


# Telangiectasia
cox_TEL <- coxph(Surv(df_filtered_event$TIBDY, df_filtered_event$CEOCCUR) ~ TELANG, data = df_filtered_event)
summary(cox_TEL)


# Capillary density (mean ≤ 7 vs. > 7) - reversed order
cox_CAPDENS <- coxph(Surv(df_filtered_event$TIBDY, df_filtered_event$CEOCCUR) ~ factor(CAPDENS7, levels = c("2", "1")), data = df_filtered_event)
summary_CAPDENS <- summary(cox_CAPDENS)
print(summary_CAPDENS)

# Scleroderma pattern (Nailfold Capillaroscopy)
cox_SCLERPAT <- coxph(Surv(df_filtered_event$TIBDY, df_filtered_event$CEOCCUR) ~ NCM_SCLERPAT, data = df_filtered_event)
summary_SCLERPAT <- summary(cox_SCLERPAT)
print(summary_SCLERPAT)

# Puffy Fingers
cox_PF <- coxph(Surv(df_filtered_event$TIBDY, df_filtered_event$CEOCCUR) ~ PUFFYFING, data = df_filtered_event)
summary_PF <- summary(cox_PF)
print(summary_PF)

## Table 3: Log-rank analysis by subgroup
## Log-rank tests

# ENA status
log_rank_test <- survdiff(surv_object ~ ENA_GRP, data = df_filtered_event)
print(log_rank_test)

# AGE
log_rank_test <- survdiff(Surv(pmin(df_filtered_event$ASTDT_years, 5), df_filtered_event$CEOCCUR) ~ AGE, data = df_filtered_event)
print(log_rank_test)

# SEX
log_rank_test <- survdiff(Surv(pmin(df_filtered_event$ASTDT_years, 5), df_filtered_event$CEOCCUR) ~ SEX, data = df_filtered_event)
print(log_rank_test)

# Telengiectasia
log_rank_test <- survdiff(Surv(pmin(df_filtered_event$ASTDT_years, 5), df_filtered_event$CEOCCUR) ~ CLVAL, data = df_filtered_event)
print(log_rank_test)

# Capillary density
log_rank_test <- survdiff(Surv(pmin(df_filtered_event$ASTDT_years, 5), df_filtered_event$CEOCCUR) ~ factor(LBTEST4, levels = c("1", "2")), data = df_filtered_event)
print(log_rank_test)

# Scleroderma pattern
log_rank_test <- survdiff(Surv(pmin(df_filtered_event$TIBDY, 5), df_filtered_event$CEOCCUR) ~ NCM_SCLERPAT, data = df_filtered_event)
print(log_rank_test)

# Puffy Fingers
log_rank_test <- survdiff(Surv(pmin(df_filtered_event$TIBDY, 5), df_filtered_event$CEOCCUR) ~ PUFFYFING, data = df_filtered_event)
print(log_rank_test)
